# ìš´ì˜ ê°€ì´ë“œ

## ğŸ› ï¸ ì„œë¹„ìŠ¤ ì œì–´ ëª…ë ¹

### ì„œë¹„ìŠ¤ ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬

#### ì¼ì‹œ ì •ì§€/ì¬ê°œ (ë©”ëª¨ë¦¬ ìœ ì§€)
```bash
# ëª¨ë“  ì„œë¹„ìŠ¤ ì¼ì‹œ ì •ì§€ (ìƒíƒœ ë³´ì¡´)
make pause

# ì¼ì‹œ ì •ì§€ëœ ì„œë¹„ìŠ¤ ì¬ê°œ
make unpause
```
**íŠ¹ì§•**: ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ì™€ ìƒíƒœë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œ CPU ì‚¬ìš©ë§Œ ì¤‘ë‹¨

#### ì •ì§€/ì‹œì‘ (ì»¨í…Œì´ë„ˆ ìœ ì§€)
```bash
# ëª¨ë“  ì„œë¹„ìŠ¤ ì •ì§€
make stop

# ì •ì§€ëœ ì„œë¹„ìŠ¤ ì‹œì‘
make start
```
**íŠ¹ì§•**: ì»¨í…Œì´ë„ˆëŠ” ìœ ì§€í•˜ë˜ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œ

#### ì•ˆì „í•œ ì •ì§€/ì‹œì‘ (ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥)
```bash
# ì²˜ë¦¬ ì¤‘ì¸ ì‘ì—… ì™„ë£Œ ëŒ€ê¸° í›„ ì •ì§€
make safe-stop

# ì•ˆì „í•˜ê²Œ ì‹œì‘ (stuck ì‘ì—… ì •ë¦¬)
make safe-start
```
**íŠ¹ì§•**:
- ì²˜ë¦¬ ì¤‘ì¸ ì‘ì—…ì„ pendingìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë¦¬ì…‹
- ì„ì‹œ íŒŒì¼ ì •ë¦¬
- 1ì‹œê°„ ì´ìƒ stuckëœ ì‘ì—… ìë™ ì¬ì„¤ì •

#### ì™„ì „ ì¢…ë£Œ/ì‹œì‘ (ì»¨í…Œì´ë„ˆ ì¬ìƒì„±)
```bash
# ëª¨ë“  ì»¨í…Œì´ë„ˆ ì œê±°
make down

# ì»¨í…Œì´ë„ˆ ìƒˆë¡œ ìƒì„± ë° ì‹œì‘
make up
```
**íŠ¹ì§•**: ì»¨í…Œì´ë„ˆë¥¼ ì™„ì „íˆ ì œê±°í•˜ê³  ì¬ìƒì„± (ë³¼ë¥¨ ë°ì´í„°ëŠ” ìœ ì§€)

### ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì‹œë‚˜ë¦¬ì˜¤ë³„ ê°€ì´ë“œ

#### 1. ì§§ì€ ìœ ì§€ë³´ìˆ˜ (5ë¶„ ì´ë‚´)
```bash
# ì¼ì‹œ ì •ì§€ ì‚¬ìš©
make pause
# ... ìœ ì§€ë³´ìˆ˜ ì‘ì—… ...
make unpause
```

#### 2. ì¤‘ê°„ ìœ ì§€ë³´ìˆ˜ (30ë¶„ ì´ë‚´)
```bash
# ì•ˆì „í•œ ì •ì§€ ì‚¬ìš©
make safe-stop
# ... ìœ ì§€ë³´ìˆ˜ ì‘ì—… ...
make safe-start
```

#### 3. ì¥ê¸° ìœ ì§€ë³´ìˆ˜ (1ì‹œê°„ ì´ìƒ)
```bash
# ì™„ì „ ì¢…ë£Œ ì‚¬ìš©
make down
# ... ìœ ì§€ë³´ìˆ˜ ì‘ì—… ...
make up
make check-data  # ë°ì´í„° ì •í•©ì„± í™•ì¸
```

## ğŸ”„ ë°ì´í„° ì •í•©ì„± ê´€ë¦¬

### ì •í•©ì„± ì²´í¬

PostgreSQLê³¼ Qdrant ê°„ì˜ ë°ì´í„° ì¼ê´€ì„±ì„ ê²€ì¦í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

#### ê¸°ë³¸ ì •í•©ì„± ì²´í¬
```bash
# ë°ì´í„° ì •í•©ì„± í™•ì¸
make check-data
```

ì´ ëª…ë ¹ì€ ë‹¤ìŒì„ í™•ì¸í•©ë‹ˆë‹¤:
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ
- í•„ìˆ˜ í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€
- Qdrant ì»¬ë ‰ì…˜ ìƒíƒœ
- PostgreSQL ì²­í¬ì™€ Qdrant ë²¡í„° ì¼ì¹˜ ì—¬ë¶€
- ì˜¤ë˜ëœ processing ì‘ì—… ì¡´ì¬ ì—¬ë¶€

#### ìë™ ìˆ˜ì • ëª¨ë“œ
```bash
# ë¬¸ì œë¥¼ ë°œê²¬í•˜ê³  ìë™ìœ¼ë¡œ ìˆ˜ì •
make check-data-fix
```

ìë™ìœ¼ë¡œ ìˆ˜ì •ë˜ëŠ” ì‚¬í•­:
- ê³ ì•„ ë²¡í„° ì‚­ì œ (Qdrantì—ë§Œ ìˆëŠ” ë²¡í„°)
- 1ì¼ ì´ìƒ ì²˜ë¦¬ ì¤‘ì¸ ì‘ì—… ì¬ì„¤ì •

#### ê°œë³„ ìˆ˜ì • ì‘ì—…
```bash
# ë©ˆì¶˜ ì‘ì—…ë§Œ ì¬ì„¤ì •
make reset-stuck-jobs

# ê³ ì•„ ë²¡í„°ë§Œ ì‚­ì œ
make clean-orphans
```

### ì •í•©ì„± ë³´ê³ ì„œ í•´ì„

ì •í•©ì„± ì²´í¬ ê²°ê³¼ëŠ” ë‹¤ìŒ ìƒíƒœë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤:

- **âœ… healthy**: ëª¨ë“  ê²€ì¦ í†µê³¼
- **âš ï¸ warning**: ê²½ê³  ì‚¬í•­ ë°œê²¬ (ì˜ˆ: ê³ ì•„ ë²¡í„°, ë©ˆì¶˜ ì‘ì—…)
- **âŒ critical**: ì‹¬ê°í•œ ë¬¸ì œ ë°œê²¬ (ì˜ˆ: DB ì—°ê²° ì‹¤íŒ¨)

## ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”

### ì†Œí”„íŠ¸ ë¦¬ì…‹ (ì±„ë„ ë³´ì¡´)

ì±„ë„ ì •ë³´ëŠ” ìœ ì§€í•˜ê³  ì½˜í…ì¸  ë°ì´í„°ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.

```bash
make reset-soft
```

ì‚­ì œë˜ëŠ” ë°ì´í„°:
- âœ… ëª¨ë“  YouTube ì½˜í…ì¸ 
- âœ… STT ì²˜ë¦¬ ê²°ê³¼ (ì „ì‚¬)
- âœ… ì²­í¬ ë°ì´í„°
- âœ… Qdrant ë²¡í„°
- âœ… ì²˜ë¦¬ ì‘ì—… í
- âœ… Redis ìºì‹œ
- âœ… ì„ì‹œ íŒŒì¼

ë³´ì¡´ë˜ëŠ” ë°ì´í„°:
- ğŸ’¾ ì±„ë„ ì •ë³´ (channels í…Œì´ë¸”)

### í•˜ë“œ ë¦¬ì…‹ (ì „ì²´ ì´ˆê¸°í™”)

ëª¨ë“  ë°ì´í„°ë¥¼ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤.

```bash
make reset-hard
```

â›” **ê²½ê³ **: ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!
- ëª¨ë“  ì±„ë„ ì •ë³´
- ëª¨ë“  ì½˜í…ì¸  ë°ì´í„°
- ëª¨ë“  ì²˜ë¦¬ ê²°ê³¼
- ëª¨ë“  ë²¡í„° ë°ì´í„°

### ì´ˆê¸°í™” ì‹œë‚˜ë¦¬ì˜¤

#### 1. í…ŒìŠ¤íŠ¸ í™˜ê²½ ì´ˆê¸°í™”
```bash
# í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ë°ì´í„° ì •ë¦¬
make reset-soft

# ìƒˆ ì±„ë„ ì¶”ê°€ ë° í…ŒìŠ¤íŠ¸
```

#### 2. ì˜¤ë¥˜ ë³µêµ¬
```bash
# ì •í•©ì„± ì²´í¬
make check-data

# ë¬¸ì œê°€ ìˆìœ¼ë©´ ì†Œí”„íŠ¸ ë¦¬ì…‹
make reset-soft

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
make restart
```

#### 3. ì™„ì „ ì´ˆê¸°í™”
```bash
# ëª¨ë“  ë°ì´í„° ë°±ì—…
make backup-all

# í•˜ë“œ ë¦¬ì…‹ ì‹¤í–‰
make reset-hard

# ìƒˆë¡œìš´ ì±„ë„ ì¶”ê°€ ì‹œì‘
```

## ğŸ” ë°ì´í„° ì •í•©ì„± ëª¨ë‹ˆí„°ë§

### ì •ê¸° ì²´í¬ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# daily_integrity_check.sh

# ì •í•©ì„± ì²´í¬
if make check-data | grep -q "critical\|warning"; then
    echo "âš ï¸ ë°ì´í„° ì •í•©ì„± ë¬¸ì œ ë°œê²¬"

    # ìë™ ìˆ˜ì • ì‹œë„
    make check-data-fix

    # ì¬ê²€ì¦
    make check-data
else
    echo "âœ… ë°ì´í„° ì •í•©ì„± ì •ìƒ"
fi
```

### Cron ì‘ì—… ì„¤ì •

```bash
# crontab -e
0 2 * * * /path/to/daily_integrity_check.sh >> /var/log/integrity_check.log 2>&1
```

## ğŸ› ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ë¬¸ì œ ë° í•´ê²° ë°©ë²•

#### ë°ì´í„° ë¶ˆì¼ì¹˜
```bash
# 1. ì •í•©ì„± ì²´í¬
make check-data

# 2. ìë™ ìˆ˜ì •
make check-data-fix

# 3. ì—¬ì „íˆ ë¬¸ì œê°€ ìˆë‹¤ë©´
make reset-soft
```

#### ì²˜ë¦¬ ì‘ì—… ë©ˆì¶¤
```bash
# ë©ˆì¶˜ ì‘ì—… í™•ì¸
make check-jobs

# ë©ˆì¶˜ ì‘ì—… ì¬ì„¤ì •
make reset-stuck-jobs

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
docker restart youtube_data_processor
```

#### Qdrant ë²¡í„° ë¶ˆì¼ì¹˜
```bash
# ê³ ì•„ ë²¡í„° ì •ë¦¬
make clean-orphans

# ì „ì²´ ì •í•©ì„± ì²´í¬
make check-data-fix
```

### ë¡œê·¸ ë¶„ì„

```bash
# ì •í•©ì„± ì²´í¬ ë¡œê·¸
docker logs youtube_data_processor | grep "integrity"

# ì´ˆê¸°í™” ì‘ì—… ë¡œê·¸
docker logs youtube_data_processor | grep "reset"
```

## ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤
```bash
# ì»¨í…Œì´ë„ˆë³„ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
docker stats

# ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
df -h

# ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
free -h
```

### ë°ì´í„°ë² ì´ìŠ¤ í†µê³„
```bash
# PostgreSQL í†µê³„
make db-shell
\dt+  -- í…Œì´ë¸” í¬ê¸°
SELECT pg_database_size('youtube_agent');  -- DB í¬ê¸°

# Qdrant í†µê³„
curl http://localhost:6333/collections/youtube_content
```

## ğŸ’¾ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ ë©”ì»¤ë‹ˆì¦˜

### íŠ¸ëœì­ì…˜ ê¸°ë°˜ ì‘ì—… ì²˜ë¦¬

#### PostgreSQL ACID ë³´ì¥
- **Atomicity**: ëª¨ë“  DB ì‘ì—…ì€ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬
- **Consistency**: ì™¸ë˜í‚¤ ì œì•½ê³¼ ìƒíƒœ ì „ì´ ê·œì¹™ ì ìš©
- **Isolation**: READ COMMITTED ê²©ë¦¬ ìˆ˜ì¤€
- **Durability**: WAL(Write-Ahead Logging) í™œì„±í™”

#### ì‘ì—… ìƒíƒœ ê´€ë¦¬
```
pending â†’ processing â†’ completed/failed
```
- ì¤‘ë‹¨ ì‹œ processing â†’ pending ìë™ ë¦¬ì…‹
- ì¬ì‹œì‘ ì‹œ pending ì‘ì—… ìë™ ì¬ì²˜ë¦¬
- ì‹¤íŒ¨ ì‹œ retry_count ì¦ê°€ ë° ì¬ì‹œë„

### ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì‹œ ë°ì´í„° ë³´í˜¸

#### Graceful Shutdown í”„ë¡œì„¸ìŠ¤
1. **ì‘ì—… ì™„ë£Œ ëŒ€ê¸°** (30ì´ˆ)
2. **Processing ì‘ì—… ë¦¬ì…‹**
3. **ì„ì‹œ íŒŒì¼ ì •ë¦¬**
4. **ì„œë¹„ìŠ¤ ì •ì§€**

```python
# scripts/graceful_shutdown.py
def reset_processing_jobs(self, grace_period_seconds=30):
    # ì²˜ë¦¬ ì¤‘ì¸ ì‘ì—…ì„ ì•ˆì „í•˜ê²Œ pendingìœ¼ë¡œ ë¦¬ì…‹
    processing_jobs = session.query(ProcessingJob).filter(
        ProcessingJob.status == 'processing'
    ).all()

    for job in processing_jobs:
        job.status = 'pending'
        job.started_at = None
        job.error_message = "Service stopped during processing"
```

### ë°ì´í„° ì¼ê´€ì„± ìœ ì§€

#### Qdrant ë²¡í„° ë™ê¸°í™”
- ì²­í¬ ìƒì„± ì‹œ ë²¡í„° ì¦‰ì‹œ ìƒì„±
- ì‚­ì œ ì‹œ cascade deleteë¡œ ì¼ê´€ì„± ìœ ì§€
- ì •ê¸°ì ì¸ orphan ë²¡í„° ì •ë¦¬

#### Redis ìºì‹œ ê´€ë¦¬
- ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹œ ìë™ ìºì‹œ ì¬êµ¬ì„±
- TTL ì„¤ì •ìœ¼ë¡œ ì˜¤ë˜ëœ ë°ì´í„° ìë™ ì œê±°

## ğŸ”’ ë°±ì—… ë° ë³µêµ¬

### ì •ê¸° ë°±ì—…

```bash
# ì „ì²´ ë°±ì—…
make backup-all

# DBë§Œ ë°±ì—…
make db-backup
```

### ë³µêµ¬ ì ˆì°¨

```bash
# 1. ì„œë¹„ìŠ¤ ì¤‘ì§€
make down

# 2. DB ë³µì›
make db-restore FILE=backup_20250918.sql

# 3. ì„œë¹„ìŠ¤ ì‹œì‘
make up

# 4. ì •í•©ì„± ì²´í¬
make check-data
```

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¼ì¼ ì²´í¬
- [ ] ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ (`make ps`)
- [ ] ì—ëŸ¬ ë¡œê·¸ í™•ì¸ (`make logs-error`)
- [ ] ì²˜ë¦¬ ì‘ì—… ìƒíƒœ (`make check-jobs`)

### ì£¼ê°„ ì²´í¬
- [ ] ë°ì´í„° ì •í•©ì„± (`make check-data`)
- [ ] ë°±ì—… ìƒì„± (`make db-backup`)
- [ ] ë””ìŠ¤í¬ ê³µê°„ í™•ì¸

### ì›”ê°„ ì²´í¬
- [ ] ì „ì²´ ì‹œìŠ¤í…œ ë°±ì—… (`make backup-all`)
- [ ] ì„±ëŠ¥ ë¶„ì„
- [ ] ì˜¤ë˜ëœ ë¡œê·¸ ì •ë¦¬ (`make clean-logs`)